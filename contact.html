<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact</title>
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="price.css">
  <script src="theme.js"></script>
</head>
<body>
  <div class="price-page">
    <!-- Hamburger Menu Button -->
    <div class="hamburger-menu" onclick="toggleMobileMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay">
      <ul class="mobile-menu-list">
        <li><a href="index.html">TOP</a></li>
        <li><a href="mixing.html">Mixing</a></li>
        <li><a href="3danimation.html">3D Animation</a></li>
        <li><a href="music.html">Music</a></li>
        <li><a href="planning.html">Planning Progress</a></li>
        <li><a href="price.html">Price</a></li>
        <li><a href="contact.html" class="active">Contact</a></li>
      </ul>
      <!-- Mobile Theme Toggle -->
      <button class="mobile-theme-toggle" id="mobileThemeToggle" aria-label="Toggle theme">
        <svg class="sun-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.65 0-3 1.35-3 3s1.35 3 3 3 3-1.35 3-3-1.35-3-3-3zm1-4V2h-2v3h2zm0 17v-3h-2v3h2zM5.99 4.58l2.12 2.12 1.41-1.41-2.12-2.12-1.41 1.41zm12.02 12.02l2.12 2.12 1.41-1.41-2.12-2.12-1.41 1.41zM2 13h3v-2H2v2zm17 0h3v-2h-3v2zM5.99 19.42l1.41-1.41-2.12-2.12-1.41 1.41 2.12 2.12zM18.01 7.29l1.41-1.41-2.12-2.12-1.41 1.41 2.12 2.12z"/>
        </svg>
        <svg class="moon-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
        </svg>
      </button>
    </div>

    <!-- Side menu -->
    <nav class="side-menu">
      <ul class="menu-list">
        <li class="menu-item">
          <span class="menu-bullet"></span>
          <span class="menu-line"></span>
          <a href="index.html" class="menu-link">TOP</a>
        </li>
        <li class="menu-item">
          <span class="menu-bullet"></span>
          <span class="menu-line"></span>
          <a href="mixing.html" class="menu-link">Mixing</a>
        </li>
        <li class="menu-item">
          <span class="menu-bullet"></span>
          <span class="menu-line"></span>
          <a href="3danimation.html" class="menu-link">3D Animation</a>
        </li>
        <li class="menu-item">
          <span class="menu-bullet"></span>
          <span class="menu-line"></span>
          <a href="music.html" class="menu-link">Music</a>
        </li>
        <li class="menu-item">
          <span class="menu-bullet"></span>
          <span class="menu-line"></span>
          <a href="planning.html" class="menu-link">Planning Progress</a>
        </li>
        <li class="menu-item">
          <span class="menu-bullet"></span>
          <span class="menu-line"></span>
          <a href="price.html" class="menu-link">Price</a>
        </li>
        <li class="menu-item">
          <span class="menu-bullet active"></span>
          <a href="contact.html" class="menu-link active">Contact</a>
        </li>
      </ul>
      <!-- Social Icons -->
      <div class="social-icons">
        <a href="https://x.com/DOSUKOI_JK" target="_blank" class="social-icon" title="X (Twitter)">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </a>
        <a href="https://x.com/okazaki_yuki01" target="_blank" class="social-icon" title="X (Twitter)">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </a>
        <a href="https://discord.com/users/528093170484117518" target="_blank" class="social-icon" title="Discord">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
          </svg>
        </a>
        <!-- Theme Toggle -->
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
          <svg class="sun-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.65 0-3 1.35-3 3s1.35 3 3 3 3-1.35 3-3-1.35-3-3-3zm1-4V2h-2v3h2zm0 17v-3h-2v3h2zM5.99 4.58l2.12 2.12 1.41-1.41-2.12-2.12-1.41 1.41zm12.02 12.02l2.12 2.12 1.41-1.41-2.12-2.12-1.41 1.41zM2 13h3v-2H2v2zm17 0h3v-2h-3v2zM5.99 19.42l1.41-1.41-2.12-2.12-1.41 1.41 2.12 2.12zM18.01 7.29l1.41-1.41-2.12-2.12-1.41 1.41 2.12 2.12z"/>
          </svg>
          <svg class="moon-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
          </svg>
        </button>
      </div>
    </nav>

    <!-- Animated gradient background -->
    <div class="gradient-bg"></div>

    <!-- Grid pattern overlay -->
    <div class="grid-pattern"></div>

    <!-- Floating orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <!-- Main content -->
    <div class="content">
      <h1 class="page-title">CONTACT</h1>

      <div class="direct-contact-container">
        <button type="button" class="direct-contact-btn" onclick="openContactPopup()">
          直接連絡する
        </button>
      </div>

      <!-- Contact Popup -->
      <div class="contact-popup-overlay" id="contactPopupOverlay" onclick="closeContactPopup(event)">
        <div class="contact-popup">
          <button class="contact-popup-close" onclick="closeContactPopup()">&times;</button>
          <h3 class="contact-popup-title">連絡先を選択</h3>
          <p class="contact-popup-recommend">※ Discordでのご連絡を推奨しています</p>
          <div class="contact-popup-icons">
            <a href="https://discord.com/users/528093170484117518" target="_blank" class="contact-popup-link">
              <div class="contact-popup-icon discord">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
              </div>
              <span class="contact-popup-label">Discord</span>
              <span class="contact-popup-badge">推奨</span>
            </a>
            <a href="https://x.com/DOSUKOI_JK" target="_blank" class="contact-popup-link">
              <div class="contact-popup-icon x-twitter">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </div>
              <span class="contact-popup-label">X (Twitter)</span>
            </a>
          </div>
        </div>
      </div>

      <form id="estimateForm" class="estimate-form">
        <div class="form-group">
          <label for="name">お名前 <span class="required">*</span></label>
          <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
          <label for="songName">曲名 <span class="required">*</span></label>
          <input type="text" id="songName" name="songName" required>
        </div>

        <div class="form-group">
          <label>プラン <span class="required">*</span></label>
          <div class="radio-group" id="planGroup">
            <label class="radio-label">
              <input type="radio" name="plan" value="Short" required>
              <span>Short</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="plan" value="One Chorus">
              <span>One Chorus</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="plan" value="Full Chorus">
              <span>Full Chorus</span>
            </label>
          </div>
        </div>

        <div class="form-group" id="deliveryOptionGroup">
          <label>納期オプション</label>
          <p class="form-note">※ 通常納期：2週間（Shortのみ3日）</p>
          <div class="radio-group" id="deliveryOptions">
            <label class="radio-label" data-for="short" style="display: none;">
              <input type="radio" name="deliveryOption" value="3日">
              <span>3日</span>
            </label>
            <label class="radio-label" data-for="all">
              <input type="radio" name="deliveryOption" value="24時間以内">
              <span>24時間以内</span>
            </label>
            <label class="radio-label" data-for="standard">
              <input type="radio" name="deliveryOption" value="3日">
              <span>3日</span>
            </label>
            <label class="radio-label" data-for="standard">
              <input type="radio" name="deliveryOption" value="1週間">
              <span>1週間</span>
            </label>
            <label class="radio-label" data-for="standard">
              <input type="radio" name="deliveryOption" value="2週間">
              <span>2週間</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>その他オプション</label>
          <div class="checkbox-group" id="otherOptionsGroup">
            <label class="checkbox-label">
              <input type="checkbox" name="otherOptions" value="カットアップ">
              <span>カットアップ</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="otherOptions" value="エンコード">
              <span>エンコード</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="otherOptions" value="ハモリガイドメロ作成">
              <span>ハモリガイドメロ作成</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="remarks">備考・要望</label>
          <textarea id="remarks" name="remarks" rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="fileUrl">音源ファイルURL <span class="required">*</span></label>
          <input type="url" id="fileUrl" name="fileUrl" placeholder="https://gigafile.nu/XXXX" required>
          <p class="file-note">※ <a href="https://gigafile.nu/" target="_blank" style="color: #926bff;">ギガファイル便</a>にアップロードしてURLを貼り付けてください</p>
        </div>

        <!-- 見積金額表示 -->
        <div class="estimate-total">
          <span class="estimate-label">概算見積り金額</span>
          <span class="estimate-amount" id="estimateAmount">¥0~</span>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">送信する</button>
        <div id="uploadProgress" class="upload-progress" style="display: none;">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <p class="progress-text" id="progressText">アップロード中...</p>
        </div>
      </form>

      <div id="formMessage" class="form-message"></div>

      <!-- Submit Success Popup -->
      <div class="contact-popup-overlay" id="submitSuccessPopup" onclick="closeSubmitSuccessPopup(event)">
        <div class="contact-popup">
          <button class="contact-popup-close" onclick="closeSubmitSuccessPopup()">&times;</button>
          <h3 class="contact-popup-title">送信完了</h3>
          <p class="contact-popup-message">ご依頼ありがとうございます！<br>お手数ですが、XまたはDiscordのDMにて<br>依頼を送信した旨をご連絡ください。</p>
          <div class="contact-popup-icons">
            <a href="https://discord.com/users/528093170484117518" target="_blank" class="contact-popup-link">
              <div class="contact-popup-icon discord">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
              </div>
              <span class="contact-popup-label">Discord</span>
              <span class="contact-popup-badge">推奨</span>
            </a>
            <a href="https://x.com/DOSUKOI_JK" target="_blank" class="contact-popup-link">
              <div class="contact-popup-icon x-twitter">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </div>
              <span class="contact-popup-label">X (Twitter)</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzRJgSS8wavzPcFXkktF9WwnAkL2XBKpUHqHyOKVMRwWqNA3w12-fOPHkvy5Oeo9wJPPg/exec';

    // 料金設定
    const prices = {
      plan: {
        'Short': 2000,
        'One Chorus': 3000,
        'Full Chorus': 6000
      },
      delivery: {
        'Short': {
          '3日': 0,
          '24時間以内': 1000
        },
        'standard': {
          '2週間': 0,
          '1週間': 1500,
          '3日': 4000,
          '24時間以内': 6000
        }
      },
      options: {
        'カットアップ': 2000,
        'エンコード': 1000,
        'ハモリガイドメロ作成': 3000
      }
    };

    // 納期オプションの表示切り替え
    function updateDeliveryOptions(planValue) {
      var isShort = planValue === 'Short';
      var labels = document.querySelectorAll('#deliveryOptions .radio-label');

      for (var i = 0; i < labels.length; i++) {
        var label = labels[i];
        var forAttr = label.getAttribute('data-for');
        if (forAttr === 'standard') {
          label.style.display = isShort ? 'none' : 'flex';
        } else if (forAttr === 'short') {
          label.style.display = isShort ? 'flex' : 'none';
        } else if (forAttr === 'all') {
          // 24時間以内は常に表示
          label.style.display = 'flex';
        }
      }
    }

    // プラン選択時の納期オプション制御
    var planRadios = document.querySelectorAll('input[name="plan"]');
    for (var i = 0; i < planRadios.length; i++) {
      planRadios[i].addEventListener('change', function() {
        updateDeliveryOptions(this.value);

        // 隠れた選択肢が選択されていたらデフォルトに戻す
        var isShort = this.value === 'Short';
        var checkedDelivery = document.querySelector('input[name="deliveryOption"]:checked');
        if (checkedDelivery) {
          var parentLabel = checkedDelivery.closest('.radio-label');
          if (parentLabel && parentLabel.style.display === 'none') {
            if (isShort) {
              document.querySelector('#deliveryOptions .radio-label[data-for="short"] input').checked = true;
            } else {
              document.querySelector('input[name="deliveryOption"][value="2週間"]').checked = true;
            }
          }
        }

        calculateEstimate();
      });
    }

    // 見積金額計算
    function calculateEstimate() {
      var total = 0;
      var hasVariable = false;

      var plan = document.querySelector('input[name="plan"]:checked');
      if (plan) {
        total += prices.plan[plan.value];
      }

      var delivery = document.querySelector('input[name="deliveryOption"]:checked');
      if (delivery && plan) {
        var deliveryPrices = plan.value === 'Short' ? prices.delivery['Short'] : prices.delivery['standard'];
        total += deliveryPrices[delivery.value] || 0;
      }

      var checkedOptions = document.querySelectorAll('input[name="otherOptions"]:checked');
      for (var i = 0; i < checkedOptions.length; i++) {
        var cb = checkedOptions[i];
        total += prices.options[cb.value] || 0;
        if (cb.value === 'カットアップ' || cb.value === 'ハモリガイドメロ作成') {
          hasVariable = true;
        }
      }

      var display = document.getElementById('estimateAmount');
      if (total > 0) {
        display.textContent = '¥' + total.toLocaleString() + (hasVariable ? '~' : '');
      } else {
        display.textContent = '¥0~';
      }
    }

    // 全ての入力変更時に見積もり再計算
    var allInputs = document.querySelectorAll('input[name="plan"], input[name="deliveryOption"], input[name="otherOptions"]');
    for (var i = 0; i < allInputs.length; i++) {
      allInputs[i].addEventListener('change', calculateEstimate);
    }

    // URLパラメータから選択状態を復元
    function restoreFromUrlParams() {
      var search = window.location.search;
      if (!search) {
        console.log('URLパラメータなし');
        return;
      }

      var urlParams = new URLSearchParams(search);
      var planValue = urlParams.get('plan');
      var deliveryValue = urlParams.get('delivery');
      var optionsValue = urlParams.get('options');

      console.log('URLパラメータ:', { plan: planValue, delivery: deliveryValue, options: optionsValue });

      // プランを選択
      if (planValue) {
        var planInputs = document.querySelectorAll('input[name="plan"]');
        var planFound = false;
        for (var i = 0; i < planInputs.length; i++) {
          if (planInputs[i].value === planValue) {
            planInputs[i].checked = true;
            planFound = true;
            console.log('プラン選択:', planValue);
            // 納期オプションの表示を更新
            updateDeliveryOptions(planValue);
            break;
          }
        }
        if (!planFound) {
          console.warn('プランが見つかりません:', planValue);
        }
      }

      // 納期オプションを選択（プラン選択後に実行）
      if (deliveryValue && planValue) {
        // DOM更新を待つ
        setTimeout(function() {
          var isShort = planValue === 'Short';
          console.log('納期オプション選択開始:', deliveryValue, 'isShort:', isShort);

          // まず全てのチェックを解除
          var deliveryInputs = document.querySelectorAll('input[name="deliveryOption"]');
          for (var i = 0; i < deliveryInputs.length; i++) {
            deliveryInputs[i].checked = false;
          }

          // 適切なラジオボタンを選択
          var deliveryFound = false;
          for (var i = 0; i < deliveryInputs.length; i++) {
            var input = deliveryInputs[i];
            var parentLabel = input.closest('.radio-label');
            var forAttr = parentLabel ? parentLabel.getAttribute('data-for') : null;
            var isVisible = parentLabel && window.getComputedStyle(parentLabel).display !== 'none';
            
            // 値が一致するラジオボタンを探す
            if (input.value === deliveryValue) {
              var shouldSelect = false;
              
              // 3日の場合はプランに応じて選択
              if (deliveryValue === '3日') {
                if (isShort && forAttr === 'short') {
                  shouldSelect = true;
                } else if (!isShort && forAttr === 'standard') {
                  shouldSelect = true;
                }
              } else if (deliveryValue === '24時間以内') {
                // 24時間以内は常に表示される（data-for="all"）
                if (forAttr === 'all') {
                  shouldSelect = true;
                }
              } else {
                // その他の納期オプション（1週間、2週間）はstandardのみ
                if (forAttr === 'standard' && isVisible) {
                  shouldSelect = true;
                }
              }
              
              if (shouldSelect) {
                input.checked = true;
                deliveryFound = true;
                console.log('納期オプション選択成功:', deliveryValue, 'forAttr:', forAttr);
                // changeイベントを発火
                input.dispatchEvent(new Event('change', { bubbles: true }));
                break;
              }
            }
          }
          
          if (!deliveryFound) {
            console.warn('納期オプションが見つかりません:', deliveryValue);
            // デバッグ用：全ての納期オプションを表示
            console.log('利用可能な納期オプション:');
            for (var i = 0; i < deliveryInputs.length; i++) {
              var input = deliveryInputs[i];
              var parentLabel = input.closest('.radio-label');
              var forAttr = parentLabel ? parentLabel.getAttribute('data-for') : null;
              var isVisible = parentLabel && window.getComputedStyle(parentLabel).display !== 'none';
              console.log('  -', input.value, 'forAttr:', forAttr, 'visible:', isVisible);
            }
          }
          
          // 見積もり再計算
          calculateEstimate();
        }, 100);
      }

      // その他オプションを選択（納期オプション選択後に実行）
      if (optionsValue) {
        setTimeout(function() {
          var options = optionsValue.split(',');
          console.log('その他オプション選択開始:', options);
          var checkboxes = document.querySelectorAll('input[name="otherOptions"]');
          var optionsFound = 0;
          
          for (var i = 0; i < checkboxes.length; i++) {
            for (var j = 0; j < options.length; j++) {
              if (checkboxes[i].value === options[j]) {
                checkboxes[i].checked = true;
                optionsFound++;
                console.log('その他オプション選択成功:', options[j]);
              }
            }
          }
          
          if (optionsFound === 0 && options.length > 0) {
            console.warn('その他オプションが見つかりません:', options);
          }
          
          // 見積もり再計算
          calculateEstimate();
        }, 150);
      }

      // 見積もり再計算（納期オプションが選択されていない場合も実行）
      if (!deliveryValue || !planValue) {
        setTimeout(function() {
          calculateEstimate();
        }, 200);
      }
    }

    // ページ読み込み完了後に実行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', restoreFromUrlParams);
    } else {
      restoreFromUrlParams();
    }

    // フォーム送信
    document.getElementById('estimateForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      var submitBtn = document.getElementById('submitBtn');
      var uploadProgress = document.getElementById('uploadProgress');
      var progressFill = document.getElementById('progressFill');
      var progressText = document.getElementById('progressText');
      var formMessage = document.getElementById('formMessage');

      // UI更新
      submitBtn.disabled = true;
      submitBtn.textContent = '送信中...';
      uploadProgress.style.display = 'block';
      formMessage.style.display = 'none';
      progressFill.style.width = '30%';
      progressText.textContent = '送信中...';

      try {
        // フォームデータ取得
        var formData = new FormData(this);

        var otherOptions = [];
        var checkedBoxes = document.querySelectorAll('input[name="otherOptions"]:checked');
        for (var i = 0; i < checkedBoxes.length; i++) {
          otherOptions.push(checkedBoxes[i].value);
        }

        progressFill.style.width = '50%';

        // GASに送信
        var response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            formInfo: {
              name: formData.get('name'),
              songName: formData.get('songName'),
              plan: formData.get('plan'),
              deliveryOption: formData.get('deliveryOption') || '',
              otherOptions: otherOptions.join(', '),
              fileUrl: formData.get('fileUrl') || '',
              remarks: formData.get('remarks') || ''
            }
          })
        });

        progressFill.style.width = '100%';
        progressText.textContent = '完了！';

        // フォームリセット
        document.getElementById('estimateForm').reset();
        calculateEstimate();

        // 進捗バーを非表示
        setTimeout(function() {
          uploadProgress.style.display = 'none';
          progressFill.style.width = '0%';
        }, 1000);

        // 送信完了ポップアップを表示
        setTimeout(function() {
          openSubmitSuccessPopup();
        }, 500);

      } catch (error) {
        console.error('送信エラー:', error);
        formMessage.className = 'form-message error';
        formMessage.textContent = '送信に失敗しました。もう一度お試しください。';
        formMessage.style.display = 'block';
        uploadProgress.style.display = 'none';
      }

      // ボタンを戻す
      submitBtn.disabled = false;
      submitBtn.textContent = '送信する';
    });

    // Mobile menu toggle
    function toggleMobileMenu() {
      const hamburger = document.querySelector('.hamburger-menu');
      const overlay = document.getElementById('mobileMenuOverlay');
      hamburger.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // Contact popup functions
    function openContactPopup() {
      document.getElementById('contactPopupOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeContactPopup(event) {
      // If event exists and click was on the popup content, don't close
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('contactPopupOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Submit success popup functions
    function openSubmitSuccessPopup() {
      document.getElementById('submitSuccessPopup').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeSubmitSuccessPopup(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('submitSuccessPopup').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close popup with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeContactPopup();
        closeSubmitSuccessPopup();
      }
    });
  </script>
</body>
</html>
