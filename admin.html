<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Portfolio管理</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <!-- OGP -->
  <meta property="og:title" content="Admin - Noumenon">
  <meta property="og:description" content="Portfolio管理">
  <meta property="og:image" content="https://noumenon.jp/OGP.png">
  <meta property="og:url" content="https://noumenon.jp/admin">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Admin - Noumenon">
  <meta name="twitter:description" content="Portfolio管理">
  <meta name="twitter:image" content="https://noumenon.jp/OGP.png">
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="price.css">
  <script src="theme.js"></script>
  <style>
    .admin-container {
      position: relative;
      z-index: 10;
      width: 100%;
      min-height: 100vh;
      padding: 40px 60px 60px 340px;
    }

    .admin-title {
      font-family: 'Times New Roman', Times, serif;
      font-size: 48px;
      font-weight: bold;
      color: var(--accent-primary, #926bff);
      letter-spacing: 10px;
      margin-bottom: 40px;
      text-shadow: 0 0 40px var(--accent-glow, rgba(146, 107, 255, 0.5));
    }

    /* Login Form */
    .login-container {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .login-form {
      background: var(--bg-card, rgba(20, 20, 25, 0.9));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3));
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
    }

    .login-form h2 {
      font-family: 'Times New Roman', Times, serif;
      font-size: 32px;
      color: var(--accent-primary, #926bff);
      text-align: center;
      margin-bottom: 30px;
    }

    .login-form input {
      width: 100%;
      padding: 15px;
      background: var(--input-bg, rgba(10, 10, 15, 0.8));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3));
      border-radius: 8px;
      color: var(--text-primary, #fff);
      font-size: 16px;
      margin-bottom: 20px;
    }

    .login-form button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--accent-primary, #926bff) 0%, var(--accent-secondary, #6b92ff) 100%);
      border: none;
      border-radius: 8px;
      color: var(--text-primary, #fff);
      font-size: 16px;
      cursor: pointer;
      transition: box-shadow 0.3s ease;
    }

    .login-form button:hover {
      box-shadow: 0 0 30px rgba(146, 107, 255, 0.5);
    }

    .login-error {
      color: #ff6b6b;
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
    }

    /* Admin Panel */
    .admin-panel {
      display: none;
    }

    .admin-section {
      background: var(--bg-card, rgba(20, 20, 25, 0.8));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.2));
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .admin-section h3 {
      font-family: 'Arial', sans-serif;
      font-size: 20px;
      color: var(--accent-primary, #926bff);
      margin-bottom: 20px;
      letter-spacing: 2px;
    }

    .video-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .video-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: var(--input-bg, rgba(10, 10, 15, 0.5));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.1));
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .video-number {
      display: flex;
      align-items: center;
      gap: 5px;
      min-width: 70px;
    }

    .video-number input {
      width: 45px;
      padding: 8px;
      background: var(--input-bg, rgba(10, 10, 15, 0.8));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3));
      border-radius: 4px;
      color: var(--text-primary, #fff);
      font-size: 14px;
      text-align: center;
    }

    .video-number input:focus {
      outline: none;
      border-color: #926bff;
    }

    .video-item img {
      width: 120px;
      height: 68px;
      object-fit: cover;
      border-radius: 4px;
    }

    .video-info {
      flex: 1;
    }

    .video-info h4 {
      color: var(--text-primary, #fff);
      font-size: 14px;
      margin-bottom: 5px;
    }

    .video-info p {
      color: var(--text-dim, rgba(255, 255, 255, 0.5));
      font-size: 12px;
    }

    .video-actions {
      display: flex;
      gap: 10px;
    }

    .btn-edit, .btn-delete {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: opacity 0.3s ease;
    }

    .btn-edit {
      background: var(--accent-primary, #926bff);
      color: var(--text-primary, #fff);
    }

    .btn-delete {
      background: #ff6b6b;
      color: var(--text-primary, #fff);
    }

    .btn-edit:hover, .btn-delete:hover {
      opacity: 0.8;
    }

    /* Add Form */
    .add-form {
      display: grid;
      gap: 15px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(146, 107, 255, 0.2);
    }

    .add-form input {
      padding: 12px 15px;
      background: var(--input-bg, rgba(10, 10, 15, 0.8));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3));
      border-radius: 8px;
      color: var(--text-primary, #fff);
      font-size: 14px;
    }

    .add-form button {
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--accent-primary, #926bff) 0%, var(--accent-secondary, #6b92ff) 100%);
      border: none;
      border-radius: 8px;
      color: var(--text-primary, #fff);
      font-size: 14px;
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    /* Logout Button */
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: rgba(255, 107, 107, 0.8);
      border: none;
      border-radius: 8px;
      color: var(--text-primary, #fff);
      font-size: 14px;
      cursor: pointer;
      z-index: 100;
    }

    .logout-btn:hover {
      background: #ff6b6b;
    }

    /* Save Status */
    .save-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      background: rgba(107, 255, 107, 0.9);
      border-radius: 8px;
      color: #000;
      font-size: 14px;
      display: none;
      z-index: 100;
    }

    /* Save Button */
    .save-button-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 90;
    }

    .save-all-btn {
      padding: 15px 40px;
      background: linear-gradient(135deg, var(--accent-primary, #926bff) 0%, var(--accent-secondary, #6b92ff) 100%);
      border: none;
      border-radius: 12px;
      color: var(--text-primary, #fff);
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 20px var(--accent-muted, rgba(146, 107, 255, 0.4));
      transition: all 0.3s ease;
    }

    .save-all-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(146, 107, 255, 0.6);
    }

    .save-all-btn:active {
      transform: translateY(0);
    }

    .save-all-btn.saved {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }

    /* Edit Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--popup-bg, rgba(20, 20, 25, 0.95));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3));
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 500px;
    }

    .modal-content h3 {
      color: var(--accent-primary, #926bff);
      margin-bottom: 20px;
    }

    .modal-content input {
      width: 100%;
      padding: 12px 15px;
      background: var(--input-bg, rgba(10, 10, 15, 0.8));
      border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3));
      border-radius: 8px;
      color: var(--text-primary, #fff);
      font-size: 14px;
      margin-bottom: 15px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-save {
      background: var(--accent-primary, #926bff);
      color: var(--text-primary, #fff);
    }

    .btn-cancel {
      background: var(--text-faint, rgba(255, 255, 255, 0.2));
      color: var(--text-primary, #fff);
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(146, 107, 255, 0.3);
      padding-bottom: 0;
    }

    .tab-button {
      padding: 15px 30px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-dim, rgba(255, 255, 255, 0.5));
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 1px;
    }

    .tab-button:hover {
      color: var(--text-secondary, rgba(255, 255, 255, 0.8));
    }

    .tab-button.active {
      color: var(--accent-primary, #926bff);
      border-bottom-color: var(--accent-primary, #926bff);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    @media (max-width: 900px) {
      .admin-container {
        padding: 20px;
      }

      .admin-title {
        font-size: 32px;
      }

      .video-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .tab-navigation {
        flex-wrap: wrap;
      }

      .tab-button {
        padding: 10px 15px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="price-page">
    <!-- Animated gradient background -->
    <div class="gradient-bg"></div>
    <div class="grid-pattern"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
      <div class="login-form">
        <h2>ADMIN LOGIN</h2>
        <input type="password" id="passwordInput" placeholder="パスワードを入力">
        <button onclick="login()">ログイン</button>
        <p class="login-error" id="loginError"></p>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
      <button class="logout-btn" onclick="logout()">ログアウト</button>

      <div class="admin-container">
        <h1 class="admin-title">ADMIN</h1>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
          <button class="tab-button active" onclick="switchTab('top')">TOP</button>
          <button class="tab-button" onclick="switchTab('mixing')">Mixing</button>
          <button class="tab-button" onclick="switchTab('3d')">3D Animation</button>
          <button class="tab-button" onclick="switchTab('music')">Music</button>
          <button class="tab-button" onclick="switchTab('planning')">Planning</button>
          <button class="tab-button" onclick="switchTab('articles')">Articles</button>
        </div>

        <!-- TOP Tab Content -->
        <div class="tab-content active" id="tab-top">
          <div class="admin-section">
            <h3>TOPページ モザイク動画管理</h3>
            <p style="color: rgba(255,255,255,0.6); margin-bottom: 20px; font-size: 14px;">各スロットの動画リンクとサムネイルを編集できます（配置位置は固定）</p>
            <div class="video-list" id="topVideoList" style="max-height: 600px;"></div>
          </div>

        </div>

        <!-- Mixing Tab Content -->
        <div class="tab-content" id="tab-mixing">
          <div class="admin-section">
            <h3>Mixing Portfolio 動画管理</h3>
            <div class="video-list" id="mixingVideoList"></div>

            <div class="add-form">
              <h4 style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">新規追加</h4>
              <input type="text" id="newTitle" placeholder="タイトル">
              <input type="text" id="newYoutubeUrl" placeholder="YouTubeのURL（例: https://www.youtube.com/watch?v=xxxxx）">
              <input type="text" id="newThumbnail" placeholder="カスタムサムネイル（任意）">
              <button onclick="addVideo()">追加</button>
            </div>
          </div>

        </div>

        <!-- 3D Animation Tab Content -->
        <div class="tab-content" id="tab-3d">
          <div class="admin-section">
            <h3>3D Animation Portfolio 動画管理</h3>
            <div class="video-list" id="animation3dList"></div>

            <div class="add-form">
              <h4 style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">新規追加</h4>
              <input type="text" id="new3dTitle" placeholder="タイトル">
              <input type="text" id="new3dYoutubeUrl" placeholder="YouTubeのURL（例: https://www.youtube.com/watch?v=xxxxx）">
              <button onclick="add3dVideo()">追加</button>
            </div>
          </div>

        </div>

        <!-- Music Tab Content -->
        <div class="tab-content" id="tab-music">
          <div class="admin-section">
            <h3>Music Portfolio 音源管理</h3>
            <div class="video-list" id="musicList"></div>

            <div class="add-form">
              <h4 style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">新規追加</h4>
              <input type="text" id="newMusicTitle" placeholder="曲名">
              <input type="text" id="newSoundcloudUrl" placeholder="SoundCloudのURL（例: https://soundcloud.com/artist/track）">
              <button onclick="addMusic()">追加</button>
            </div>
          </div>

        </div>

        <!-- Planning Tab Content -->
        <div class="tab-content" id="tab-planning">
          <div class="admin-section">
            <h3>Planning Progress 作品管理</h3>
            <div class="video-list" id="planningList"></div>

            <div class="add-form">
              <h4 style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">新規追加</h4>
              <input type="text" id="newPlanningTitle" placeholder="作品タイトル">
              <input type="text" id="newPlanningYoutubeUrl" placeholder="YouTubeのURL（例: https://www.youtube.com/watch?v=xxxxx）">
              <button onclick="addPlanning()">追加</button>
            </div>
          </div>

        </div>

        <!-- Articles Tab Content -->
        <div class="tab-content" id="tab-articles">
          <div class="admin-section">
            <h3>記事管理</h3>

            <!-- GitHub認証状態 -->
            <div id="githubAuthStatus" style="margin-bottom: 20px; padding: 15px; background: var(--input-bg, rgba(10, 10, 15, 0.5)); border: 1px solid var(--border-color, rgba(146, 107, 255, 0.2)); border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span id="authStatusText" style="color: var(--text-dim, rgba(255,255,255,0.5)); font-weight: bold;">GitHub未認証</span>
                <div id="tokenInputContainer">
                  <input type="password" id="githubTokenInput" placeholder="GitHub Personal Access Token" style="padding: 10px 14px; background: var(--input-bg, rgba(10, 10, 15, 0.8)); border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3)); border-radius: 8px; color: var(--text-primary, #fff); width: 300px; font-size: 14px;">
                  <button onclick="saveGitHubToken()" style="margin-left: 10px; padding: 10px 20px; background: linear-gradient(135deg, var(--accent-primary, #926bff) 0%, var(--accent-secondary, #6b92ff) 100%); border: none; border-radius: 8px; color: var(--text-primary, #fff); cursor: pointer; font-size: 14px; font-weight: bold;">認証</button>
                </div>
                <button id="githubLogoutBtn" onclick="logoutGitHub()" style="display: none; padding: 10px 20px; background: #ff6b6b; border: none; border-radius: 8px; color: var(--text-primary, #fff); cursor: pointer; font-size: 14px;">ログアウト</button>
              </div>
              <p style="font-size: 12px; color: var(--text-dim, rgba(255,255,255,0.5)); margin-top: 12px;">
                <a href="https://github.com/settings/tokens/new?scopes=repo&description=Portfolio%20Admin" target="_blank" style="color: var(--accent-primary, #926bff); text-decoration: underline;">GitHub でトークンを作成</a>（repo スコープが必要です）
              </p>
            </div>

            <!-- 記事一覧 -->
            <div class="video-list" id="articlesList" style="max-height: 500px;">
              <p style="color: var(--text-dim, rgba(255,255,255,0.5)); text-align: center; padding: 20px;">GitHubで認証して記事を読み込んでください</p>
            </div>

            <div class="add-form">
              <h4 style="color: var(--text-secondary, rgba(255,255,255,0.8)); margin-bottom: 10px;">新規記事作成</h4>
              <input type="text" id="newArticleTitle" placeholder="記事タイトル" oninput="syncFolderName(this.value)">
              <input type="text" id="newArticleThumbnail" placeholder="サムネイル画像パス（任意、例: /content/uploads/フォルダ名/image.jpg）">
              <textarea id="newArticleSummary" placeholder="概要（任意）" style="width: 100%; padding: 12px 15px; background: var(--input-bg, rgba(10, 10, 15, 0.8)); border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3)); border-radius: 8px; color: var(--text-primary, #fff); font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
              <textarea id="newArticleBody" placeholder="本文（Markdown形式）&#10;&#10;画像を挿入する場合: ![画像の説明](/content/uploads/フォルダ名/ファイル名.jpg)" style="width: 100%; padding: 12px 15px; background: var(--input-bg, rgba(10, 10, 15, 0.8)); border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3)); border-radius: 8px; color: var(--text-primary, #fff); font-size: 14px; min-height: 200px; resize: vertical; font-family: monospace;"></textarea>

              <!-- 画像アップロード（ドラッグ&ドロップ） -->
              <div style="margin-top: 15px; padding: 15px; background: var(--input-bg, rgba(10, 10, 15, 0.5)); border: 1px solid var(--border-color, rgba(146, 107, 255, 0.2)); border-radius: 8px;">
                <p style="color: var(--text-secondary, rgba(255,255,255,0.8)); font-size: 14px; margin: 0 0 10px 0;">画像アップロード → <span id="folderPreview" style="color: var(--accent-primary, #926bff);">/content/uploads/</span></p>
                <input type="file" id="imageUploadInput" accept="image/*" multiple style="display: none;">
                <div id="dropZone" onclick="document.getElementById('imageUploadInput').click()" style="border: 2px dashed var(--border-color, rgba(146, 107, 255, 0.4)); border-radius: 8px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--input-bg, rgba(10, 10, 15, 0.3));">
                  <svg style="width: 40px; height: 40px; margin-bottom: 10px; fill: var(--text-muted, rgba(255,255,255,0.4));" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                  <p style="color: var(--text-secondary, rgba(255,255,255,0.7)); font-size: 14px; margin: 0;">ここに画像をドラッグ&ドロップ</p>
                  <p style="color: var(--text-muted, rgba(255,255,255,0.4)); font-size: 12px; margin: 5px 0 0 0;">またはクリックしてファイルを選択</p>
                </div>
                <div id="uploadProgress" style="display: none; margin-top: 12px;">
                  <p id="uploadingFileName" style="color: var(--text-secondary, rgba(255,255,255,0.7)); font-size: 14px; margin: 0 0 8px 0;"></p>
                  <div style="background: var(--input-bg, rgba(10, 10, 15, 0.8)); border-radius: 4px; height: 6px; overflow: hidden;">
                    <div id="uploadProgressBar" style="background: linear-gradient(135deg, var(--accent-primary, #926bff) 0%, var(--accent-secondary, #6b92ff) 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                  </div>
                </div>
                <div id="uploadedImagePath" style="margin-top: 12px; display: none; padding: 12px; background: rgba(107, 255, 107, 0.1); border: 1px solid rgba(107, 255, 107, 0.3); border-radius: 8px;">
                  <p style="color: #6bff6b; font-size: 14px; margin: 0;">アップロード完了: <code id="imagePathCode" style="background: var(--input-bg, rgba(10,10,15,0.8)); padding: 6px 10px; border-radius: 4px; user-select: all; color: var(--text-primary, #fff);">パス</code></p>
                  <button type="button" onclick="copyImagePath()" style="margin-top: 8px; padding: 8px 16px; background: var(--input-bg, rgba(10, 10, 15, 0.8)); border: 1px solid rgba(107, 255, 107, 0.3); border-radius: 6px; color: #6bff6b; cursor: pointer; font-size: 13px;">パスをコピー</button>
                  <button type="button" onclick="insertImageToBody()" style="margin-top: 8px; margin-left: 8px; padding: 8px 16px; background: var(--input-bg, rgba(10, 10, 15, 0.8)); border: 1px solid rgba(107, 255, 107, 0.3); border-radius: 6px; color: #6bff6b; cursor: pointer; font-size: 13px;">本文に挿入</button>
                </div>
              </div>

              <button onclick="createArticle()" style="margin-top: 15px;">記事を作成</button>
            </div>
          </div>

        </div>

      </div>
    </div>

    <!-- Edit TOP Modal -->
    <div class="modal" id="editTopModal">
      <div class="modal-content">
        <h3>TOPスロットを編集</h3>
        <p id="editTopSlotName" style="color: rgba(255,255,255,0.6); margin-bottom: 15px; font-size: 14px;"></p>
        <input type="text" id="editTopLink" placeholder="YouTubeのURL">
        <input type="text" id="editTopThumbnail" placeholder="カスタムサムネイル（任意、空欄でYouTubeサムネ使用）">
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="closeTopModal()">キャンセル</button>
          <button class="btn-save" onclick="saveTopEdit()">保存</button>
        </div>
      </div>
    </div>

    <!-- Edit Mixing Modal -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <h3>Mixing動画を編集</h3>
        <input type="text" id="editTitle" placeholder="タイトル">
        <input type="text" id="editYoutubeUrl" placeholder="YouTubeのURL">
        <input type="text" id="editThumbnail" placeholder="カスタムサムネイル（任意）">
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="closeModal()">キャンセル</button>
          <button class="btn-save" onclick="saveEdit()">保存</button>
        </div>
      </div>
    </div>

    <!-- Edit Music Modal -->
    <div class="modal" id="editMusicModal">
      <div class="modal-content">
        <h3>音源を編集</h3>
        <input type="text" id="editMusicTitle" placeholder="曲名">
        <input type="text" id="editSoundcloudUrl" placeholder="SoundCloudのURL">
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="closeMusicModal()">キャンセル</button>
          <button class="btn-save" onclick="saveMusicEdit()">保存</button>
        </div>
      </div>
    </div>

    <!-- Edit 3D Animation Modal -->
    <div class="modal" id="edit3dModal">
      <div class="modal-content">
        <h3>3D Animation動画を編集</h3>
        <input type="text" id="edit3dTitle" placeholder="タイトル">
        <input type="text" id="edit3dYoutubeUrl" placeholder="YouTubeのURL">
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="close3dModal()">キャンセル</button>
          <button class="btn-save" onclick="save3dEdit()">保存</button>
        </div>
      </div>
    </div>

    <!-- Edit Planning Modal -->
    <div class="modal" id="editPlanningModal">
      <div class="modal-content">
        <h3>Planning作品を編集</h3>
        <input type="text" id="editPlanningTitle" placeholder="作品タイトル">
        <input type="text" id="editPlanningYoutubeUrl" placeholder="YouTubeのURL">
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="closePlanningModal()">キャンセル</button>
          <button class="btn-save" onclick="savePlanningEdit()">保存</button>
        </div>
      </div>
    </div>

    <!-- Edit Article Modal -->
    <div class="modal" id="editArticleModal">
      <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <h3>記事を編集</h3>
        <input type="hidden" id="editArticleSlug">
        <input type="hidden" id="editArticleSha">
        <input type="text" id="editArticleTitle" placeholder="タイトル">
        <input type="text" id="editArticleThumbnail" placeholder="サムネイル画像パス（任意）">
        <textarea id="editArticleSummary" placeholder="概要（任意）" style="width: 100%; padding: 12px 15px; background: var(--input-bg, rgba(10, 10, 15, 0.8)); border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3)); border-radius: 8px; color: var(--text-primary, #fff); font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
        <textarea id="editArticleBody" placeholder="本文（Markdown形式）" style="width: 100%; padding: 12px 15px; background: var(--input-bg, rgba(10, 10, 15, 0.8)); border: 1px solid var(--border-color, rgba(146, 107, 255, 0.3)); border-radius: 8px; color: var(--text-primary, #fff); font-size: 14px; min-height: 300px; resize: vertical; font-family: monospace;"></textarea>
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="closeArticleModal()">キャンセル</button>
          <button class="btn-save" onclick="saveArticleEdit()">保存</button>
        </div>
      </div>
    </div>

    <div class="save-status" id="saveStatus">保存しました</div>

    <!-- Save Button -->
    <div class="save-button-container" id="saveButtonContainer" style="display: none;">
      <button class="save-all-btn" onclick="saveAllData()">すべて保存</button>
    </div>
  </div>

  <script>
    // パスワード設定
    const ADMIN_PASSWORD = 'abc99387';

    // ローカルストレージのキー
    const STORAGE_KEY = 'portfolio_videos';
    const MUSIC_STORAGE_KEY = 'portfolio_music';
    const ANIMATION3D_STORAGE_KEY = 'portfolio_3d_animation';
    const PLANNING_STORAGE_KEY = 'portfolio_planning';
    const TOP_STORAGE_KEY = 'portfolio_top_videos';

    // デフォルトの動画データ
    const defaultVideos = [
      { id: '3qpLV6US96M', title: '18歳が / 全力で【化けの花】歌ってみた', link: 'https://www.youtube.com/watch?v=3qpLV6US96M' },
      { id: 'XP-nYV8GAOo', title: "Hell's Greatest Dad/Hazbin Hotel - ver.Rim", link: 'https://www.youtube.com/watch?v=XP-nYV8GAOo' },
      { id: 'd21zmSD-Oh4', title: '【怜巳】百花繚乱☆スターマイン / 雪乃イト【歌ってみた】', link: 'https://www.youtube.com/watch?v=d21zmSD-Oh4' },
      { id: '6hn1pNWSCNI', title: '【お化け5人が】HALLOWEEN PARTY/歌ってみた【どるれく】', link: 'https://www.youtube.com/watch?v=6hn1pNWSCNI' },
      { id: 'Ag9Ay7XJC24', title: '【オリジナルMV】脱法ロック／歌ってみた【あぽす×みぬた】', link: 'https://www.youtube.com/watch?v=Ag9Ay7XJC24' },
      { id: 'KWbXAIrVWxk', title: 'ファタール / GEMN 歌ってみた 【まいたけxかにちゃん】', link: 'https://www.youtube.com/watch?v=KWbXAIrVWxk' },
      { id: 'ArdkSMvRqxo', title: 'ハオ / 歌ってみた【みそら】', link: 'https://www.youtube.com/watch?v=ArdkSMvRqxo' },
      { id: 'khYh9nJxO9o', title: 'Love Forever - ジョアンナ町田×緋赤まい(Cover)', link: 'https://www.youtube.com/watch?v=khYh9nJxO9o' },
      { id: '2X77fyZSIM4', title: 'アンノウン・マザーグース(wowaka)/尾長真昼cover', link: 'https://www.youtube.com/watch?v=2X77fyZSIM4' },
      { id: 'VVUW23SBnoE', title: 'セリフありで】キングスレイヤー / あれと【歌ってみた / めるぷれ】', link: 'https://www.youtube.com/watch?v=VVUW23SBnoE' },
      { id: '-W3QisNkoCQ', title: '【三兄弟で】のだ / 歌ってみた 【まぎすと】', link: 'https://www.youtube.com/watch?v=-W3QisNkoCQ' },
      { id: 'Et7CpkC1ilI', title: '【ボカデュオ2024】　泡沫　Team 響曲〜kyoma〜', link: 'https://www.youtube.com/watch?v=Et7CpkC1ilI' },
      { id: 'PBd2yrrnZ-4', title: 'UNDEAD/cover.ネア', link: 'https://www.youtube.com/watch?v=PBd2yrrnZ-4' },
      { id: 'ZSEfPjaEjEs', title: '【歌ってみた】私は、私達は(Guiano)/尾長真昼cover', link: 'https://www.youtube.com/watch?v=ZSEfPjaEjEs' },
      { id: 'BAFzZ3hgccU', title: '【ショタカテ配信者が】3周年記念に【しわ】歌ってみた', link: 'https://www.youtube.com/watch?v=BAFzZ3hgccU' },
      { id: '73K8Q4F-Uo0', title: '【アニメ賭ケグルイOP】Deal with the devil / coverはなまる', link: 'https://www.youtube.com/watch?v=73K8Q4F-Uo0' },
      { id: 'wXdpFwtZk5A', title: 'Tonight ~月の下眠る君~ - マクドナルド･ジョアンナ･まい (Cover)', link: 'https://www.youtube.com/watch?v=wXdpFwtZk5A' }
    ];

    let videos = [];
    let musicList = [];
    let animation3dList = [];
    let planningList = [];
    let topSlots = [];
    let editIndex = -1;
    let editMusicIndex = -1;
    let edit3dIndex = -1;
    let editPlanningIndex = -1;
    let editTopIndex = -1;

    // TOPページのスロット定義（位置は固定、動画情報のみ編集可能）
    const defaultTopSlots = [
      { slotName: 'スロット1: Deal with the devil（大）', link: 'https://www.youtube.com/watch?v=73K8Q4F-Uo0', customThumbnail: '' },
      { slotName: 'スロット2: ハオ（縦長）', link: 'https://www.youtube.com/watch?v=ArdkSMvRqxo', customThumbnail: '' },
      { slotName: 'スロット3: 百花繚乱（横長）', link: 'https://www.youtube.com/watch?v=d21zmSD-Oh4', customThumbnail: '' },
      { slotName: 'スロット4: のだ（横長）', link: 'https://www.youtube.com/watch?v=-W3QisNkoCQ', customThumbnail: '' },
      { slotName: 'スロット5: しわ（縦長）', link: 'https://www.youtube.com/watch?v=BAFzZ3hgccU', customThumbnail: '' },
      { slotName: 'スロット6: HALLOWEEN PARTY（横長）', link: 'https://www.youtube.com/watch?v=6hn1pNWSCNI', customThumbnail: '' },
      { slotName: 'スロット7: 泡沫（縦長）', link: 'https://www.youtube.com/watch?v=Et7CpkC1ilI', customThumbnail: '' },
      { slotName: 'スロット8: 脱法ロック（横長）', link: 'https://www.youtube.com/watch?v=Ag9Ay7XJC24', customThumbnail: '' },
      { slotName: 'スロット9: UNDEAD（縦長）', link: 'https://www.youtube.com/watch?v=PBd2yrrnZ-4', customThumbnail: '' },
      { slotName: 'スロット10: Hells Greatest Dad（横長）', link: 'https://www.youtube.com/watch?v=XP-nYV8GAOo', customThumbnail: '' },
      { slotName: 'スロット11: Love Forever（横長）', link: 'https://www.youtube.com/watch?v=khYh9nJxO9o', customThumbnail: '' },
      { slotName: 'スロット12: アンノウン（縦長）', link: 'https://www.youtube.com/watch?v=2X77fyZSIM4', customThumbnail: '' },
      { slotName: 'スロット13: Tonight（横長）', link: 'https://www.youtube.com/watch?v=wXdpFwtZk5A', customThumbnail: '' },
      { slotName: 'スロット14: キングスレイヤー（縦長）', link: 'https://www.youtube.com/watch?v=VVUW23SBnoE', customThumbnail: '' },
      { slotName: 'スロット15: ファタール（横長）', link: 'https://www.youtube.com/watch?v=KWbXAIrVWxk', customThumbnail: '' },
      { slotName: 'スロット16: 私は、私達は（横長）', link: 'https://www.youtube.com/watch?v=ZSEfPjaEjEs', customThumbnail: 'onaga-saisho.jpg' },
      { slotName: 'スロット17: 化けの花（最大）', link: 'https://www.youtube.com/watch?v=3qpLV6US96M', customThumbnail: '' }
    ];

    // デフォルトの3Dアニメーションデータ
    const default3dVideos = [
      { id: 'YlREYofJlZU', title: '3D Animation 1', link: 'https://www.youtube.com/watch?v=YlREYofJlZU' },
      { id: 'FQwnJEvqYfE', title: '3D Animation 2', link: 'https://www.youtube.com/watch?v=FQwnJEvqYfE' },
      { id: '_J-Dhutoz_k', title: '3D Animation 3', link: 'https://www.youtube.com/watch?v=_J-Dhutoz_k' }
    ];

    // 初期化
    function init() {
      // TOPスロットデータ
      const savedTop = localStorage.getItem(TOP_STORAGE_KEY);
      if (savedTop) {
        const parsed = JSON.parse(savedTop);
        // 新しいフォーマット（slotNameを持つ）かチェック
        if (parsed.length > 0 && parsed[0].slotName) {
          topSlots = parsed;
        } else {
          // 古いフォーマットの場合はリセット
          topSlots = JSON.parse(JSON.stringify(defaultTopSlots));
          saveTopSlots();
        }
      } else {
        topSlots = JSON.parse(JSON.stringify(defaultTopSlots));
        saveTopSlots();
      }

      // Mixing動画データ
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        videos = JSON.parse(saved);
      } else {
        videos = [...defaultVideos];
        saveVideos();
      }

      // 音源データ
      const savedMusic = localStorage.getItem(MUSIC_STORAGE_KEY);
      if (savedMusic) {
        musicList = JSON.parse(savedMusic);
      } else {
        // デフォルトの音源データ
        musicList = [
          { title: '01a1', embedUrl: 'https://w.soundcloud.com/player/?url=https%3A%2F%2Fsoundcloud.com%2Fhx62trzckls7%2F01a1&color=%23926bff&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=true', originalUrl: 'https://soundcloud.com/hx62trzckls7/01a1' },
          { title: '02a', embedUrl: 'https://w.soundcloud.com/player/?url=https%3A%2F%2Fsoundcloud.com%2Fhx62trzckls7%2F02a&color=%23926bff&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=true', originalUrl: 'https://soundcloud.com/hx62trzckls7/02a' },
          { title: '03a', embedUrl: 'https://w.soundcloud.com/player/?url=https%3A%2F%2Fsoundcloud.com%2Fhx62trzckls7%2F03a&color=%23926bff&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=true', originalUrl: 'https://soundcloud.com/hx62trzckls7/03a' },
          { title: '04a', embedUrl: 'https://w.soundcloud.com/player/?url=https%3A%2F%2Fsoundcloud.com%2Fhx62trzckls7%2F04a&color=%23926bff&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=true', originalUrl: 'https://soundcloud.com/hx62trzckls7/04a' },
          { title: '05wav', embedUrl: 'https://w.soundcloud.com/player/?url=https%3A%2F%2Fsoundcloud.com%2Fhx62trzckls7%2F05wav&color=%23926bff&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=true', originalUrl: 'https://soundcloud.com/hx62trzckls7/05wav' },
          { title: '06a1', embedUrl: 'https://w.soundcloud.com/player/?url=https%3A%2F%2Fsoundcloud.com%2Fhx62trzckls7%2F06a1&color=%23926bff&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=true', originalUrl: 'https://soundcloud.com/hx62trzckls7/06a1' }
        ];
        saveMusic();
      }

      // 3Dアニメーションデータ
      const saved3d = localStorage.getItem(ANIMATION3D_STORAGE_KEY);
      if (saved3d) {
        animation3dList = JSON.parse(saved3d);
      } else {
        animation3dList = [...default3dVideos];
        save3dVideos();
      }

      // Planningデータ
      const savedPlanning = localStorage.getItem(PLANNING_STORAGE_KEY);
      if (savedPlanning) {
        planningList = JSON.parse(savedPlanning);
      } else {
        // デフォルトのPlanningデータ
        planningList = [
          { id: 'UAV_q6xKtu4', title: 'ドキシック/かわいいJKふぁん倶楽部', link: 'https://www.youtube.com/watch?v=UAV_q6xKtu4' }
        ];
        savePlanning();
      }

      // ログイン状態確認
      if (sessionStorage.getItem('admin_logged_in') === 'true') {
        showAdminPanel();
      }
    }

    // ログイン
    function login() {
      const password = document.getElementById('passwordInput').value;
      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('admin_logged_in', 'true');
        showAdminPanel();
      } else {
        document.getElementById('loginError').textContent = 'パスワードが違います';
      }
    }

    // ログアウト
    function logout() {
      sessionStorage.removeItem('admin_logged_in');
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('saveButtonContainer').style.display = 'none';
      document.getElementById('passwordInput').value = '';
    }

    // 管理パネル表示
    function showAdminPanel() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('saveButtonContainer').style.display = 'block';
      renderTopList();
      renderVideoList();
      render3dList();
      renderMusicList();
      renderPlanningList();
    }

    // すべてのデータを保存
    function saveAllData() {
      saveTopSlots();
      saveVideos();
      save3dVideos();
      saveMusic();
      savePlanning();

      // ボタンの見た目を変更
      const btn = document.querySelector('.save-all-btn');
      btn.textContent = '保存しました！';
      btn.classList.add('saved');

      // 2秒後に元に戻す
      setTimeout(() => {
        btn.textContent = 'すべて保存';
        btn.classList.remove('saved');
      }, 2000);

      showSaveStatus();
    }

    // 動画リスト表示
    function renderVideoList() {
      const list = document.getElementById('mixingVideoList');
      list.innerHTML = '';

      if (videos.length === 0) {
        list.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">動画がまだありません</p>';
        return;
      }

      videos.forEach((video, index) => {
        let thumbnailId = video.id;
        if (video.link) {
          const match = video.link.match(/[?&]v=([^&]+)/);
          if (match) thumbnailId = match[1];
        }

        const thumbnailUrl = video.customThumbnail || `https://img.youtube.com/vi/${thumbnailId}/mqdefault.jpg`;

        const videoLink = video.link || `https://www.youtube.com/watch?v=${thumbnailId}`;

        const item = document.createElement('div');
        item.className = 'video-item';
        item.innerHTML = `
          <div class="video-number">
            <input type="number" value="${index + 1}" min="1" max="${videos.length}" onchange="moveVideoToPosition(${index}, this.value)" title="順番を変更">
          </div>
          <a href="${videoLink}" target="_blank" style="display: block;">
            <img src="${thumbnailUrl}" alt="${video.title}" onerror="this.src='https://img.youtube.com/vi/${video.id}/mqdefault.jpg'" style="cursor: pointer;">
          </a>
          <div class="video-info">
            <h4>${video.title}</h4>
            <p>ID: ${video.id}</p>
          </div>
          <div class="video-actions">
            <button class="btn-edit" onclick="openEdit(${index})">編集</button>
            <button class="btn-delete" onclick="deleteVideo(${index})">削除</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // YouTubeのURLから動画IDを抽出
    function extractVideoId(url) {
      // 様々なYouTube URLパターンに対応
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([^&\n?#]+)/,
        /^([a-zA-Z0-9_-]{11})$/  // 動画IDのみの場合
      ];

      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          return match[1];
        }
      }
      return null;
    }

    // 動画追加
    function addVideo() {
      const title = document.getElementById('newTitle').value.trim();
      const youtubeUrl = document.getElementById('newYoutubeUrl').value.trim();
      const thumbnail = document.getElementById('newThumbnail').value.trim();

      if (!title || !youtubeUrl) {
        alert('タイトルとYouTubeのURLは必須です');
        return;
      }

      const videoId = extractVideoId(youtubeUrl);
      if (!videoId) {
        alert('有効なYouTubeのURLを入力してください');
        return;
      }

      const newVideo = {
        id: videoId,
        title: title,
        link: youtubeUrl
      };

      if (thumbnail) {
        newVideo.customThumbnail = thumbnail;
      }

      videos.unshift(newVideo);
      saveVideos();
      renderVideoList();

      // フォームクリア
      document.getElementById('newTitle').value = '';
      document.getElementById('newYoutubeUrl').value = '';
      document.getElementById('newThumbnail').value = '';

      showSaveStatus();
    }

    // 動画削除
    function deleteVideo(index) {
      if (confirm(`「${videos[index].title}」を削除しますか？`)) {
        videos.splice(index, 1);
        saveVideos();
        renderVideoList();
        showSaveStatus();
      }
    }

    // Mixing動画を指定位置に移動
    function moveVideoToPosition(currentIndex, newPosition) {
      const targetIndex = parseInt(newPosition) - 1;
      if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= videos.length || targetIndex === currentIndex) {
        renderVideoList(); // 無効な値の場合はリセット
        return;
      }

      const item = videos.splice(currentIndex, 1)[0];
      videos.splice(targetIndex, 0, item);
      saveVideos();
      renderVideoList();
      showSaveStatus();
    }

    // 編集モーダルを開く
    function openEdit(index) {
      editIndex = index;
      const video = videos[index];
      document.getElementById('editTitle').value = video.title;
      document.getElementById('editYoutubeUrl').value = video.link || `https://www.youtube.com/watch?v=${video.id}`;
      document.getElementById('editThumbnail').value = video.customThumbnail || '';
      document.getElementById('editModal').style.display = 'flex';
    }

    // モーダルを閉じる
    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      editIndex = -1;
    }

    // 編集を保存
    function saveEdit() {
      if (editIndex === -1) return;

      const title = document.getElementById('editTitle').value.trim();
      const youtubeUrl = document.getElementById('editYoutubeUrl').value.trim();
      const thumbnail = document.getElementById('editThumbnail').value.trim();

      if (!title || !youtubeUrl) {
        alert('タイトルとYouTubeのURLは必須です');
        return;
      }

      const videoId = extractVideoId(youtubeUrl);
      if (!videoId) {
        alert('有効なYouTubeのURLを入力してください');
        return;
      }

      videos[editIndex] = {
        id: videoId,
        title: title,
        link: youtubeUrl
      };

      if (thumbnail) {
        videos[editIndex].customThumbnail = thumbnail;
      }

      saveVideos();
      renderVideoList();
      closeModal();
      showSaveStatus();
    }

    // 保存
    function saveVideos() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(videos));
    }

    // ========== TOP管理機能 ==========

    // TOPリスト表示
    function renderTopList() {
      const list = document.getElementById('topVideoList');
      list.innerHTML = '';

      topSlots.forEach((slot, index) => {
        // リンクからビデオIDを抽出
        let videoId = '';
        if (slot.link) {
          const match = slot.link.match(/[?&]v=([^&]+)/);
          if (match) videoId = match[1];
        }

        const thumbnailUrl = slot.customThumbnail || (videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : '');

        const item = document.createElement('div');
        item.className = 'video-item';
        item.innerHTML = `
          <div class="video-number" style="min-width: 40px;">
            <span style="color: #926bff; font-weight: bold;">${index + 1}</span>
          </div>
          ${thumbnailUrl ? `
            <a href="${slot.link}" target="_blank" style="display: block;">
              <img src="${thumbnailUrl}" alt="${slot.slotName}" onerror="this.src='https://img.youtube.com/vi/${videoId}/hqdefault.jpg'" style="cursor: pointer;">
            </a>
          ` : `
            <div style="width: 120px; height: 68px; background: rgba(146, 107, 255, 0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
              <span style="color: rgba(255,255,255,0.5);">No Video</span>
            </div>
          `}
          <div class="video-info">
            <h4>${slot.slotName}</h4>
            <p style="font-size: 11px; word-break: break-all;">${slot.link || '未設定'}</p>
            ${slot.customThumbnail ? `<p style="font-size: 10px; color: #926bff;">カスタムサムネ: ${slot.customThumbnail}</p>` : ''}
          </div>
          <div class="video-actions">
            <button class="btn-edit" onclick="openTopEdit(${index})">編集</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // TOP編集モーダルを開く
    function openTopEdit(index) {
      editTopIndex = index;
      const slot = topSlots[index];
      document.getElementById('editTopSlotName').textContent = slot.slotName;
      document.getElementById('editTopLink').value = slot.link || '';
      document.getElementById('editTopThumbnail').value = slot.customThumbnail || '';
      document.getElementById('editTopModal').style.display = 'flex';
    }

    // TOPモーダルを閉じる
    function closeTopModal() {
      document.getElementById('editTopModal').style.display = 'none';
      editTopIndex = -1;
    }

    // TOP編集を保存
    function saveTopEdit() {
      if (editTopIndex === -1) return;

      const link = document.getElementById('editTopLink').value.trim();
      const thumbnail = document.getElementById('editTopThumbnail').value.trim();

      if (!link) {
        alert('YouTubeのURLは必須です');
        return;
      }

      // URLの基本チェック
      if (!link.includes('youtube.com') && !link.includes('youtu.be')) {
        alert('有効なYouTubeのURLを入力してください');
        return;
      }

      topSlots[editTopIndex].link = link;
      topSlots[editTopIndex].customThumbnail = thumbnail;

      saveTopSlots();
      renderTopList();
      closeTopModal();
      showSaveStatus();
    }

    // TOPスロットデータを保存
    function saveTopSlots() {
      localStorage.setItem(TOP_STORAGE_KEY, JSON.stringify(topSlots));
    }

    // ========== ここまでTOP管理機能 ==========

    // 保存ステータス表示
    function showSaveStatus() {
      const status = document.getElementById('saveStatus');
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, 2000);
    }

    // ========== Music管理機能 ==========

    // SoundCloudのURLを埋め込みURLに変換
    function convertToSoundcloudEmbed(url) {
      // SoundCloudの埋め込みURL形式に変換
      // https://soundcloud.com/artist/track -> https://w.soundcloud.com/player/?url=...
      const encodedUrl = encodeURIComponent(url);
      return `https://w.soundcloud.com/player/?url=${encodedUrl}&color=%23926bff&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false`;
    }

    // 音源リスト表示
    function renderMusicList() {
      const list = document.getElementById('musicList');
      list.innerHTML = '';

      if (musicList.length === 0) {
        list.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">音源がまだありません</p>';
        return;
      }

      musicList.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'video-item';
        item.innerHTML = `
          <div class="video-number">
            <input type="number" value="${index + 1}" min="1" max="${musicList.length}" onchange="moveMusicToPosition(${index}, this.value)" title="順番を変更">
          </div>
          <a href="${track.originalUrl || '#'}" target="_blank" style="display: block; width: 120px; height: 68px; background: rgba(146, 107, 255, 0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            <span style="font-size: 24px;">🎵</span>
          </a>
          <div class="video-info">
            <h4>${track.title}</h4>
            <p style="font-size: 11px; word-break: break-all;">${track.originalUrl || 'SoundCloud'}</p>
          </div>
          <div class="video-actions">
            <button class="btn-edit" onclick="openMusicEdit(${index})">編集</button>
            <button class="btn-delete" onclick="deleteMusic(${index})">削除</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // 音源追加
    function addMusic() {
      const title = document.getElementById('newMusicTitle').value.trim();
      const soundcloudUrl = document.getElementById('newSoundcloudUrl').value.trim();

      if (!title || !soundcloudUrl) {
        alert('曲名とSoundCloudのURLは必須です');
        return;
      }

      // SoundCloudのURL検証（基本的なチェック）
      if (!soundcloudUrl.includes('soundcloud.com')) {
        alert('有効なSoundCloudのURLを入力してください');
        return;
      }

      const embedUrl = convertToSoundcloudEmbed(soundcloudUrl);

      const newTrack = {
        title: title,
        embedUrl: embedUrl,
        originalUrl: soundcloudUrl
      };

      musicList.unshift(newTrack);
      saveMusic();
      renderMusicList();

      // フォームクリア
      document.getElementById('newMusicTitle').value = '';
      document.getElementById('newSoundcloudUrl').value = '';

      showSaveStatus();
    }

    // 音源削除
    function deleteMusic(index) {
      if (confirm(`「${musicList[index].title}」を削除しますか？`)) {
        musicList.splice(index, 1);
        saveMusic();
        renderMusicList();
        showSaveStatus();
      }
    }

    // 音源を指定位置に移動
    function moveMusicToPosition(currentIndex, newPosition) {
      const targetIndex = parseInt(newPosition) - 1;
      if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= musicList.length || targetIndex === currentIndex) {
        renderMusicList(); // 無効な値の場合はリセット
        return;
      }

      const item = musicList.splice(currentIndex, 1)[0];
      musicList.splice(targetIndex, 0, item);
      saveMusic();
      renderMusicList();
      showSaveStatus();
    }

    // 音源編集モーダルを開く
    function openMusicEdit(index) {
      editMusicIndex = index;
      const track = musicList[index];
      document.getElementById('editMusicTitle').value = track.title;
      document.getElementById('editSoundcloudUrl').value = track.originalUrl || '';
      document.getElementById('editMusicModal').style.display = 'flex';
    }

    // 音源モーダルを閉じる
    function closeMusicModal() {
      document.getElementById('editMusicModal').style.display = 'none';
      editMusicIndex = -1;
    }

    // 音源編集を保存
    function saveMusicEdit() {
      if (editMusicIndex === -1) return;

      const title = document.getElementById('editMusicTitle').value.trim();
      const soundcloudUrl = document.getElementById('editSoundcloudUrl').value.trim();

      if (!title || !soundcloudUrl) {
        alert('曲名とSoundCloudのURLは必須です');
        return;
      }

      if (!soundcloudUrl.includes('soundcloud.com')) {
        alert('有効なSoundCloudのURLを入力してください');
        return;
      }

      const embedUrl = convertToSoundcloudEmbed(soundcloudUrl);

      musicList[editMusicIndex] = {
        title: title,
        embedUrl: embedUrl,
        originalUrl: soundcloudUrl
      };

      saveMusic();
      renderMusicList();
      closeMusicModal();
      showSaveStatus();
    }

    // 音源データを保存
    function saveMusic() {
      localStorage.setItem(MUSIC_STORAGE_KEY, JSON.stringify(musicList));
    }

    // ========== ここまでMusic管理機能 ==========

    // ========== 3D Animation管理機能 ==========

    // 3Dアニメーションリスト表示
    function render3dList() {
      const list = document.getElementById('animation3dList');
      list.innerHTML = '';

      if (animation3dList.length === 0) {
        list.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">動画がまだありません</p>';
        return;
      }

      animation3dList.forEach((video, index) => {
        const thumbnailUrl = `https://img.youtube.com/vi/${video.id}/mqdefault.jpg`;
        const videoLink = video.link || `https://www.youtube.com/watch?v=${video.id}`;

        const item = document.createElement('div');
        item.className = 'video-item';
        item.innerHTML = `
          <div class="video-number">
            <input type="number" value="${index + 1}" min="1" max="${animation3dList.length}" onchange="move3dToPosition(${index}, this.value)" title="順番を変更">
          </div>
          <a href="${videoLink}" target="_blank" style="display: block;">
            <img src="${thumbnailUrl}" alt="${video.title}" onerror="this.src='https://img.youtube.com/vi/${video.id}/hqdefault.jpg'" style="cursor: pointer;">
          </a>
          <div class="video-info">
            <h4>${video.title}</h4>
            <p>ID: ${video.id}</p>
          </div>
          <div class="video-actions">
            <button class="btn-edit" onclick="open3dEdit(${index})">編集</button>
            <button class="btn-delete" onclick="delete3dVideo(${index})">削除</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // 3D動画追加
    function add3dVideo() {
      const title = document.getElementById('new3dTitle').value.trim();
      const youtubeUrl = document.getElementById('new3dYoutubeUrl').value.trim();

      if (!title || !youtubeUrl) {
        alert('タイトルとYouTubeのURLは必須です');
        return;
      }

      const videoId = extractVideoId(youtubeUrl);
      if (!videoId) {
        alert('有効なYouTubeのURLを入力してください');
        return;
      }

      const newVideo = {
        id: videoId,
        title: title,
        link: youtubeUrl
      };

      animation3dList.unshift(newVideo);
      save3dVideos();
      render3dList();

      // フォームクリア
      document.getElementById('new3dTitle').value = '';
      document.getElementById('new3dYoutubeUrl').value = '';

      showSaveStatus();
    }

    // 3D動画削除
    function delete3dVideo(index) {
      if (confirm(`「${animation3dList[index].title}」を削除しますか？`)) {
        animation3dList.splice(index, 1);
        save3dVideos();
        render3dList();
        showSaveStatus();
      }
    }

    // 3D動画を指定位置に移動
    function move3dToPosition(currentIndex, newPosition) {
      const targetIndex = parseInt(newPosition) - 1;
      if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= animation3dList.length || targetIndex === currentIndex) {
        render3dList(); // 無効な値の場合はリセット
        return;
      }

      const item = animation3dList.splice(currentIndex, 1)[0];
      animation3dList.splice(targetIndex, 0, item);
      save3dVideos();
      render3dList();
      showSaveStatus();
    }

    // 3D動画編集モーダルを開く
    function open3dEdit(index) {
      edit3dIndex = index;
      const video = animation3dList[index];
      document.getElementById('edit3dTitle').value = video.title;
      document.getElementById('edit3dYoutubeUrl').value = video.link || `https://www.youtube.com/watch?v=${video.id}`;
      document.getElementById('edit3dModal').style.display = 'flex';
    }

    // 3Dモーダルを閉じる
    function close3dModal() {
      document.getElementById('edit3dModal').style.display = 'none';
      edit3dIndex = -1;
    }

    // 3D動画編集を保存
    function save3dEdit() {
      if (edit3dIndex === -1) return;

      const title = document.getElementById('edit3dTitle').value.trim();
      const youtubeUrl = document.getElementById('edit3dYoutubeUrl').value.trim();

      if (!title || !youtubeUrl) {
        alert('タイトルとYouTubeのURLは必須です');
        return;
      }

      const videoId = extractVideoId(youtubeUrl);
      if (!videoId) {
        alert('有効なYouTubeのURLを入力してください');
        return;
      }

      animation3dList[edit3dIndex] = {
        id: videoId,
        title: title,
        link: youtubeUrl
      };

      save3dVideos();
      render3dList();
      close3dModal();
      showSaveStatus();
    }

    // 3Dアニメーションデータを保存
    function save3dVideos() {
      localStorage.setItem(ANIMATION3D_STORAGE_KEY, JSON.stringify(animation3dList));
    }

    // ========== ここまで3D Animation管理機能 ==========

    // ========== Planning Progress管理機能 ==========

    // Planningリスト表示
    function renderPlanningList() {
      const list = document.getElementById('planningList');
      list.innerHTML = '';

      if (planningList.length === 0) {
        list.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">作品がまだありません</p>';
        return;
      }

      planningList.forEach((video, index) => {
        const thumbnailUrl = `https://img.youtube.com/vi/${video.id}/mqdefault.jpg`;
        const videoLink = video.link || `https://www.youtube.com/watch?v=${video.id}`;

        const item = document.createElement('div');
        item.className = 'video-item';
        item.innerHTML = `
          <div class="video-number">
            <input type="number" value="${index + 1}" min="1" max="${planningList.length}" onchange="movePlanningToPosition(${index}, this.value)" title="順番を変更">
          </div>
          <a href="${videoLink}" target="_blank" style="display: block;">
            <img src="${thumbnailUrl}" alt="${video.title}" onerror="this.src='https://img.youtube.com/vi/${video.id}/hqdefault.jpg'" style="cursor: pointer;">
          </a>
          <div class="video-info">
            <h4>${video.title}</h4>
            <p>ID: ${video.id}</p>
          </div>
          <div class="video-actions">
            <button class="btn-edit" onclick="openPlanningEdit(${index})">編集</button>
            <button class="btn-delete" onclick="deletePlanning(${index})">削除</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // Planning作品追加
    function addPlanning() {
      const title = document.getElementById('newPlanningTitle').value.trim();
      const youtubeUrl = document.getElementById('newPlanningYoutubeUrl').value.trim();

      if (!title || !youtubeUrl) {
        alert('作品タイトルとYouTubeのURLは必須です');
        return;
      }

      const videoId = extractVideoId(youtubeUrl);
      if (!videoId) {
        alert('有効なYouTubeのURLを入力してください');
        return;
      }

      const newVideo = {
        id: videoId,
        title: title,
        link: youtubeUrl
      };

      planningList.unshift(newVideo);
      savePlanning();
      renderPlanningList();

      // フォームクリア
      document.getElementById('newPlanningTitle').value = '';
      document.getElementById('newPlanningYoutubeUrl').value = '';

      showSaveStatus();
    }

    // Planning作品削除
    function deletePlanning(index) {
      if (confirm(`「${planningList[index].title}」を削除しますか？`)) {
        planningList.splice(index, 1);
        savePlanning();
        renderPlanningList();
        showSaveStatus();
      }
    }

    // Planning作品を指定位置に移動
    function movePlanningToPosition(currentIndex, newPosition) {
      const targetIndex = parseInt(newPosition) - 1;
      if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= planningList.length || targetIndex === currentIndex) {
        renderPlanningList(); // 無効な値の場合はリセット
        return;
      }

      const item = planningList.splice(currentIndex, 1)[0];
      planningList.splice(targetIndex, 0, item);
      savePlanning();
      renderPlanningList();
      showSaveStatus();
    }

    // Planning編集モーダルを開く
    function openPlanningEdit(index) {
      editPlanningIndex = index;
      const video = planningList[index];
      document.getElementById('editPlanningTitle').value = video.title;
      document.getElementById('editPlanningYoutubeUrl').value = video.link || `https://www.youtube.com/watch?v=${video.id}`;
      document.getElementById('editPlanningModal').style.display = 'flex';
    }

    // Planningモーダルを閉じる
    function closePlanningModal() {
      document.getElementById('editPlanningModal').style.display = 'none';
      editPlanningIndex = -1;
    }

    // Planning編集を保存
    function savePlanningEdit() {
      if (editPlanningIndex === -1) return;

      const title = document.getElementById('editPlanningTitle').value.trim();
      const youtubeUrl = document.getElementById('editPlanningYoutubeUrl').value.trim();

      if (!title || !youtubeUrl) {
        alert('作品タイトルとYouTubeのURLは必須です');
        return;
      }

      const videoId = extractVideoId(youtubeUrl);
      if (!videoId) {
        alert('有効なYouTubeのURLを入力してください');
        return;
      }

      planningList[editPlanningIndex] = {
        id: videoId,
        title: title,
        link: youtubeUrl
      };

      savePlanning();
      renderPlanningList();
      closePlanningModal();
      showSaveStatus();
    }

    // Planningデータを保存
    function savePlanning() {
      localStorage.setItem(PLANNING_STORAGE_KEY, JSON.stringify(planningList));
    }

    // ========== ここまでPlanning Progress管理機能 ==========

    // ========== タブ切り替え機能 ==========

    function switchTab(tabName, saveState = true) {
      // すべてのタブボタンからactiveクラスを削除
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // すべてのタブコンテンツを非表示
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // 対応するタブボタンにactiveクラスを追加
      const tabButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
      if (tabButton) {
        tabButton.classList.add('active');
      }

      // 対応するタブコンテンツを表示
      document.getElementById('tab-' + tabName).classList.add('active');

      // タブ状態を保存
      if (saveState) {
        localStorage.setItem('admin_active_tab', tabName);
      }
    }

    // 保存されたタブ状態を復元
    function restoreTab() {
      const savedTab = localStorage.getItem('admin_active_tab');
      if (savedTab) {
        const tabContent = document.getElementById('tab-' + savedTab);
        if (tabContent) {
          switchTab(savedTab, false);
        }
      }
    }

    // ページ読み込み時にタブを復元
    document.addEventListener('DOMContentLoaded', restoreTab);

    // ========== ここまでタブ切り替え機能 ==========

    // ========== Articles管理機能（GitHub API） ==========

    const GITHUB_REPO = 'okazaki893/portfolio-site';
    const GITHUB_BRANCH = 'main';
    const ARTICLES_PATH = 'content/articles';
    const UPLOADS_PATH = 'content/uploads';
    const GITHUB_TOKEN_KEY = 'github_access_token';

    let articlesList = [];

    // GitHub Personal Access Tokenを保存
    async function saveGitHubToken() {
      const token = document.getElementById('githubTokenInput').value.trim();
      if (!token) {
        alert('トークンを入力してください');
        return;
      }

      // トークンの有効性をチェック
      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          alert('無効なトークンです');
          return;
        }

        localStorage.setItem(GITHUB_TOKEN_KEY, token);
        document.getElementById('githubTokenInput').value = '';
        updateAuthStatus(true);
        loadArticles();

      } catch (error) {
        console.error('Token validation error:', error);
        alert('トークンの検証に失敗しました');
      }
    }

    // 認証状態を更新
    function updateAuthStatus(authenticated) {
      const statusText = document.getElementById('authStatusText');
      const tokenInputContainer = document.getElementById('tokenInputContainer');
      const logoutBtn = document.getElementById('githubLogoutBtn');

      if (authenticated) {
        statusText.textContent = 'GitHub認証済み';
        statusText.style.color = '#6bff6b';
        tokenInputContainer.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
      } else {
        statusText.textContent = 'GitHub未認証';
        statusText.style.color = 'rgba(255,255,255,0.6)';
        tokenInputContainer.style.display = 'block';
        logoutBtn.style.display = 'none';
      }
    }

    // GitHubログアウト
    function logoutGitHub() {
      localStorage.removeItem(GITHUB_TOKEN_KEY);
      updateAuthStatus(false);
      articlesList = [];
      renderArticlesList();
    }

    // 記事一覧を取得
    async function loadArticles() {
      const token = localStorage.getItem(GITHUB_TOKEN_KEY);
      if (!token) {
        renderArticlesList();
        return;
      }

      try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${ARTICLES_PATH}?ref=${GITHUB_BRANCH}`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (response.status === 404) {
          // フォルダが存在しない場合
          articlesList = [];
          renderArticlesList();
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to fetch articles');
        }

        const files = await response.json();
        articlesList = [];

        // 各Markdownファイルの情報を取得
        for (const file of files) {
          if (file.name.endsWith('.md')) {
            const contentRes = await fetch(file.url, {
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            const contentData = await contentRes.json();
            // UTF-8でBase64デコード
            const binaryString = atob(contentData.content.replace(/\n/g, ''));
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            const content = new TextDecoder('utf-8').decode(bytes);
            const meta = parseArticleFrontMatter(content);

            articlesList.push({
              slug: file.name.replace('.md', ''),
              sha: contentData.sha,
              title: meta.title || 'Untitled',
              date: meta.date || new Date().toISOString(),
              thumbnail: meta.thumbnail || '',
              summary: meta.summary || '',
              body: extractArticleBody(content)
            });
          }
        }

        // 日付順でソート（新しい順）
        articlesList.sort((a, b) => new Date(b.date) - new Date(a.date));
        renderArticlesList();

      } catch (error) {
        console.error('Error loading articles:', error);
        document.getElementById('articlesList').innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: 20px;">記事の読み込みに失敗しました</p>';
      }
    }

    // フロントマターをパース
    function parseArticleFrontMatter(content) {
      const match = content.match(/^---\n([\s\S]*?)\n---/);
      if (!match) return {};

      const frontMatter = match[1];
      const meta = {};

      frontMatter.split('\n').forEach(line => {
        const colonIndex = line.indexOf(':');
        if (colonIndex > -1) {
          const key = line.substring(0, colonIndex).trim();
          let value = line.substring(colonIndex + 1).trim();
          if ((value.startsWith('"') && value.endsWith('"')) ||
              (value.startsWith("'") && value.endsWith("'"))) {
            value = value.slice(1, -1);
          }
          meta[key] = value;
        }
      });

      return meta;
    }

    // 本文を抽出
    function extractArticleBody(content) {
      const match = content.match(/^---\n[\s\S]*?\n---\n([\s\S]*)$/);
      return match ? match[1].trim() : content;
    }

    // 記事一覧を表示
    function renderArticlesList() {
      const list = document.getElementById('articlesList');

      if (articlesList.length === 0) {
        list.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">記事がまだありません</p>';
        return;
      }

      list.innerHTML = '';

      articlesList.forEach((article, index) => {
        const date = new Date(article.date).toLocaleDateString('ja-JP');

        const item = document.createElement('div');
        item.className = 'video-item';
        item.innerHTML = `
          <div class="video-number" style="min-width: 40px;">
            <span style="color: #926bff; font-weight: bold;">${index + 1}</span>
          </div>
          ${article.thumbnail ? `
            <img src="${article.thumbnail}" alt="${article.title}" style="width: 120px; height: 68px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'">
          ` : `
            <div style="width: 120px; height: 68px; background: rgba(146, 107, 255, 0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 24px;">📝</span>
            </div>
          `}
          <div class="video-info">
            <h4>${article.title}</h4>
            <p>${date}</p>
            ${article.summary ? `<p style="font-size: 11px; color: rgba(255,255,255,0.5);">${article.summary.substring(0, 50)}${article.summary.length > 50 ? '...' : ''}</p>` : ''}
          </div>
          <div class="video-actions">
            <button class="btn-edit" onclick="openArticleEdit(${index})">編集</button>
            <button class="btn-delete" onclick="deleteArticle(${index})">削除</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // 記事を作成
    async function createArticle() {
      const token = localStorage.getItem(GITHUB_TOKEN_KEY);
      if (!token) {
        alert('GitHubで認証してください');
        return;
      }

      const title = document.getElementById('newArticleTitle').value.trim();
      const thumbnail = document.getElementById('newArticleThumbnail').value.trim();
      const summary = document.getElementById('newArticleSummary').value.trim();
      const body = document.getElementById('newArticleBody').value.trim();

      if (!title) {
        alert('タイトルは必須です');
        return;
      }

      // スラッグを生成（日本語対応）
      const slug = title.toLowerCase()
        .replace(/[^\w\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'article-' + Date.now();

      const date = new Date().toISOString();

      // Markdownコンテンツを生成
      let content = `---\ntitle: "${title}"\ndate: ${date}\n`;
      if (thumbnail) content += `thumbnail: "${thumbnail}"\n`;
      if (summary) content += `summary: "${summary}"\n`;
      content += `---\n\n${body}`;

      try {
        // UTF-8でBase64エンコード
        const encoder = new TextEncoder();
        const data = encoder.encode(content);
        const base64Content = btoa(String.fromCharCode(...data));

        const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${ARTICLES_PATH}/${slug}.md`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Add article: ${title}`,
            content: base64Content,
            branch: GITHUB_BRANCH
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('GitHub API Error:', errorData);
          throw new Error(errorData.message || 'Failed to create article');
        }

        // フォームをクリア
        document.getElementById('newArticleTitle').value = '';
        document.getElementById('newArticleThumbnail').value = '';
        document.getElementById('newArticleSummary').value = '';
        document.getElementById('newArticleBody').value = '';
        currentFolderName = '';
        document.getElementById('folderPreview').textContent = '/content/uploads/';

        showSaveStatus();
        loadArticles();

      } catch (error) {
        console.error('Error creating article:', error);
        alert('記事の作成に失敗しました: ' + error.message);
      }
    }

    // 記事編集モーダルを開く
    function openArticleEdit(index) {
      const article = articlesList[index];
      document.getElementById('editArticleSlug').value = article.slug;
      document.getElementById('editArticleSha').value = article.sha;
      document.getElementById('editArticleTitle').value = article.title;
      document.getElementById('editArticleThumbnail').value = article.thumbnail || '';
      document.getElementById('editArticleSummary').value = article.summary || '';
      document.getElementById('editArticleBody').value = article.body || '';
      document.getElementById('editArticleModal').style.display = 'flex';
    }

    // 記事モーダルを閉じる
    function closeArticleModal() {
      document.getElementById('editArticleModal').style.display = 'none';
    }

    // 記事編集を保存
    async function saveArticleEdit() {
      const token = localStorage.getItem(GITHUB_TOKEN_KEY);
      if (!token) {
        alert('GitHubで認証してください');
        return;
      }

      const slug = document.getElementById('editArticleSlug').value;
      const sha = document.getElementById('editArticleSha').value;
      const title = document.getElementById('editArticleTitle').value.trim();
      const thumbnail = document.getElementById('editArticleThumbnail').value.trim();
      const summary = document.getElementById('editArticleSummary').value.trim();
      const body = document.getElementById('editArticleBody').value.trim();

      if (!title) {
        alert('タイトルは必須です');
        return;
      }

      // 既存の記事を見つけて日付を保持
      const existingArticle = articlesList.find(a => a.slug === slug);
      const date = existingArticle ? existingArticle.date : new Date().toISOString();

      // Markdownコンテンツを生成
      let content = `---\ntitle: "${title}"\ndate: ${date}\n`;
      if (thumbnail) content += `thumbnail: "${thumbnail}"\n`;
      if (summary) content += `summary: "${summary}"\n`;
      content += `---\n\n${body}`;

      try {
        // UTF-8でBase64エンコード
        const encoder = new TextEncoder();
        const data = encoder.encode(content);
        const base64Content = btoa(String.fromCharCode(...data));

        const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${ARTICLES_PATH}/${slug}.md`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Update article: ${title}`,
            content: base64Content,
            sha: sha,
            branch: GITHUB_BRANCH
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('GitHub API Error:', errorData);
          throw new Error(errorData.message || 'Failed to update article');
        }

        closeArticleModal();
        showSaveStatus();
        loadArticles();

      } catch (error) {
        console.error('Error updating article:', error);
        alert('記事の更新に失敗しました: ' + error.message);
      }
    }

    // 記事を削除（画像フォルダも一緒に削除）
    async function deleteArticle(index) {
      const article = articlesList[index];

      if (!confirm(`「${article.title}」を削除しますか？\n※関連する画像フォルダも削除されます`)) {
        return;
      }

      const token = localStorage.getItem(GITHUB_TOKEN_KEY);
      if (!token) {
        alert('GitHubで認証してください');
        return;
      }

      try {
        // 画像フォルダのパスを生成（スラッグと同じ形式）
        const folderName = article.slug;
        const folderPath = `${UPLOADS_PATH}/${folderName}`;

        // まず画像フォルダ内のファイルを取得して削除
        try {
          const folderResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${folderPath}?ref=${GITHUB_BRANCH}`, {
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });

          if (folderResponse.ok) {
            const files = await folderResponse.json();

            // フォルダ内の各ファイルを削除
            for (const file of files) {
              await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${file.path}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `token ${token}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Delete image: ${file.name}`,
                  sha: file.sha,
                  branch: GITHUB_BRANCH
                })
              });
            }
            console.log(`Deleted image folder: ${folderPath}`);
          }
        } catch (folderError) {
          // フォルダが存在しない場合はスキップ
          console.log('No image folder found or already deleted');
        }

        // 最新のSHAを取得（他の場所で変更されている可能性があるため）
        const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${ARTICLES_PATH}/${article.slug}.md?ref=${GITHUB_BRANCH}`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!getResponse.ok) {
          throw new Error('記事ファイルが見つかりません');
        }

        const fileData = await getResponse.json();

        // 記事ファイルを削除
        const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${ARTICLES_PATH}/${article.slug}.md`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Delete article: ${article.title}`,
            sha: fileData.sha,
            branch: GITHUB_BRANCH
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to delete article');
        }

        showSaveStatus();
        loadArticles();

      } catch (error) {
        console.error('Error deleting article:', error);
        alert('記事の削除に失敗しました: ' + error.message);
      }
    }

    // ========== 画像アップロード機能 ==========

    let currentFolderName = '';

    // 記事タイトルからフォルダ名を同期
    function syncFolderName(title) {
      if (title.trim()) {
        // タイトルをスラッグ化（日本語対応）
        currentFolderName = title.trim()
          .toLowerCase()
          .replace(/\s+/g, '-')
          .replace(/[^a-zA-Z0-9\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf-]/g, '')
          .replace(/^-+|-+$/g, '');
        document.getElementById('folderPreview').textContent = `/content/uploads/${currentFolderName}/`;
      } else {
        currentFolderName = '';
        document.getElementById('folderPreview').textContent = '/content/uploads/';
      }
    }

    // ドラッグ&ドロップの初期化
    document.addEventListener('DOMContentLoaded', function() {
      const dropZone = document.getElementById('dropZone');
      const imageInput = document.getElementById('imageUploadInput');

      if (dropZone && imageInput) {
        // ドラッグオーバー時のスタイル変更
        dropZone.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
          dropZone.style.borderColor = 'var(--accent-primary, #926bff)';
          dropZone.style.background = 'rgba(146, 107, 255, 0.1)';
        });

        dropZone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          e.stopPropagation();
          dropZone.style.borderColor = 'var(--border-color, rgba(146, 107, 255, 0.4))';
          dropZone.style.background = 'var(--input-bg, rgba(10, 10, 15, 0.3))';
        });

        // ドロップ時の処理
        dropZone.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
          dropZone.style.borderColor = 'var(--border-color, rgba(146, 107, 255, 0.4))';
          dropZone.style.background = 'var(--input-bg, rgba(10, 10, 15, 0.3))';

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleImageUpload(files);
          }
        });

        // ファイル選択時の処理
        imageInput.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            handleImageUpload(e.target.files);
          }
        });
      }
    });

    // 画像アップロード処理（複数ファイル対応）
    async function handleImageUpload(files) {
      const token = localStorage.getItem(GITHUB_TOKEN_KEY);
      if (!token) {
        alert('GitHubで認証してください');
        return;
      }

      // 記事タイトルが入力されていない場合は警告
      if (!currentFolderName) {
        alert('先に記事タイトルを入力してください');
        return;
      }

      const progressDiv = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('uploadProgressBar');
      const fileNameDisplay = document.getElementById('uploadingFileName');

      let lastUploadedPath = '';

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // 画像ファイルかチェック
        if (!file.type.startsWith('image/')) {
          continue;
        }

        // プログレス表示
        progressDiv.style.display = 'block';
        fileNameDisplay.textContent = `アップロード中: ${file.name} (${i + 1}/${files.length})`;
        progressBar.style.width = '0%';

        // ファイル名を生成（日時 + 元のファイル名）
        const timestamp = Date.now();
        const safeFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
        const fileName = `${timestamp}_${safeFileName}`;

        // アップロードパスを決定
        const uploadPath = `${UPLOADS_PATH}/${currentFolderName}/${fileName}`;

        try {
          progressBar.style.width = '30%';

          // ファイルをBase64に変換
          const base64Content = await fileToBase64(file);

          progressBar.style.width = '60%';

          const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${uploadPath}`, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Upload image to ${currentFolderName}: ${fileName}`,
              content: base64Content,
              branch: GITHUB_BRANCH
            })
          });

          if (!response.ok) {
            throw new Error('Failed to upload image');
          }

          progressBar.style.width = '100%';
          lastUploadedPath = `/${uploadPath}`;

        } catch (error) {
          console.error('Error uploading image:', error);
          alert(`画像のアップロードに失敗しました: ${file.name}`);
        }
      }

      // アップロード完了
      progressDiv.style.display = 'none';
      document.getElementById('imageUploadInput').value = '';

      if (lastUploadedPath) {
        document.getElementById('imagePathCode').textContent = lastUploadedPath;
        document.getElementById('uploadedImagePath').style.display = 'block';
        showSaveStatus();
      }
    }

    // 画像を本文に挿入
    function insertImageToBody() {
      const path = document.getElementById('imagePathCode').textContent;
      const bodyTextarea = document.getElementById('newArticleBody');
      const markdownImage = `![画像](${path})`;

      // カーソル位置に挿入
      const start = bodyTextarea.selectionStart;
      const end = bodyTextarea.selectionEnd;
      const text = bodyTextarea.value;
      bodyTextarea.value = text.substring(0, start) + markdownImage + text.substring(end);

      // カーソルを挿入後の位置に移動
      bodyTextarea.selectionStart = bodyTextarea.selectionEnd = start + markdownImage.length;
      bodyTextarea.focus();
    }

    // ファイルをBase64に変換
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // data:image/xxx;base64, の部分を除去
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // 画像パスをコピー
    function copyImagePath() {
      const path = document.getElementById('imagePathCode').textContent;
      navigator.clipboard.writeText(path).then(() => {
        alert('パスをコピーしました');
      }).catch(() => {
        // フォールバック
        const textArea = document.createElement('textarea');
        textArea.value = path;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('パスをコピーしました');
      });
    }

    // ========== ここまで画像アップロード機能 ==========

    // 初期化時にGitHub認証状態をチェック
    function initArticles() {
      const token = localStorage.getItem(GITHUB_TOKEN_KEY);
      if (token) {
        updateAuthStatus(true);
        loadArticles();
      }
    }

    // ========== ここまでArticles管理機能 ==========

    // Enterキーでログイン
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        login();
      }
    });

    // 初期化実行
    init();
    initArticles();
  </script>
</body>
</html>
